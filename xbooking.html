<?php
//session_start();
//if (!isset($_SESSION['username'])) {
    //header("Location: login.php");
  //  exit();
//}

$posts = json_decode(file_get_contents('chat.json'), true);
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['post_content'])) {
    $new_post = [
        'id' => uniqid(),
        'content' => $_POST['post_content'],
        'author' => $_SESSION['username'],
        'timestamp' => time(),
        'replies' => []
    ];

    $posts[] = $new_post;
    file_put_contents('chat.json', json_encode($posts));
}

if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['reply_content'], $_POST['post_id'])) {
    foreach ($posts as &$post) {
        if ($post['id'] === $_POST['post_id']) {
            $post['replies'][] = [
                'content' => $_POST['reply_content'],
                'author' => $_SESSION['username'],
                'timestamp' => time()
            ];
            break;
        }
    }

    file_put_contents('chat.json', json_encode($posts));
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Forum</title>
</head>
<body>
    <?php include 'navbar.php'; ?>
<div class="container">
<h2>Welcome, <?php echo $_SESSION['username']; ?></h2>

<form method="POST">
    <textarea name="post_content" placeholder="Share your idea..." required></textarea><br/>
    <button type="submit">Post</button>
</form>

<h3>Posts:</h3>

<?php foreach ($posts as $post): ?>
<div style='border:1px solid #ccc; padding:10px; margin-bottom:10px;'>
    <p><strong><?php echo htmlspecialchars($post['author']); ?></strong>: <?php echo htmlspecialchars($post['content']); ?></p>

    <?php foreach ($post['replies'] as $reply): ?>
        <p><em><?php echo htmlspecialchars($reply['author']); ?></em>: <?php echo htmlspecialchars($reply['content']); ?></p>
    <?php endforeach; ?>

    <form method='POST'>
        <input type='hidden' name='post_id' value='<?php echo $post["id"]; ?>'>
        <textarea name='reply_content' placeholder='Reply...' required></textarea><br/>
        <button type='submit'>Reply</button>
    </form>

</div>
<?php endforeach; ?>

<a href='logout.php'>Logout</a>

</div>

<!-- Clear old posts after 24 hours -->
<?php
$time_limit = 86400; // 24 hours in seconds
foreach ($posts as $key => $post) {
    if (time() - $post['timestamp'] > $time_limit) {
        unset($posts[$key]);
    }
}
file_put_contents('booking.json', json_encode(array_values($posts)));
?>
    <?php include 'footer.php'; ?>
</body>
</html>
